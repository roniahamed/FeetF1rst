<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Backend Google Login Test</title>
    <!-- jQuery লাইব্রেরি যোগ করা হয়েছে -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- পেজের স্টাইলিং-এর জন্য CSS -->
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 25px; line-height: 1.6; background-color: #f8f9fa; color: #333; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h4 { text-align: center; }
        button { 
            display: block; width: 100%; padding: 12px 15px; font-size: 16px; cursor: pointer; 
            border: none; border-radius: 5px; color: white; margin-top: 10px;
        }
        #google-login-btn { background-color: #4285F4; }
        #logout-btn { background-color: #d9534f; }
        #fetch-profile-btn { background-color: #5cb85c; }
        #user-info, #api-response { display: none; margin-top: 20px; }
        pre { background-color: #e9ecef; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
        .status-box { padding: 12px; border-radius: 5px; margin: 20px 0; text-align: center; }
        .status-success { background-color: #d1e7dd; color: #0f5132; }
        .status-error { background-color: #f8d7da; color: #842029; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Django Backend Google Login Test</h1>

        <!-- Login Button Section -->
        <div id="login-section">
            <p style="text-align: center;">আপনার ব্যাকএন্ড পরীক্ষা করতে নিচের বাটনে ক্লিক করুন।</p>
            <button id="google-login-btn">Login with Google</button>
        </div>

        <!-- Status Messages Section -->
        <div id="status-container"></div>

        <!-- Logged In User Info Section -->
        <div id="user-info">
            <h2>স্বাগতম! আপনি সফলভাবে লগইন করেছেন।</h2>
            <h4>Backend থেকে প্রাপ্ত JWT Tokens:</h4>
            <pre id="jwt-tokens"></pre>
            
            <hr style="margin: 20px 0;">

            <h4>এখন এই টোকেন দিয়ে একটি সুরক্ষিত API পরীক্ষা করুন:</h4>
            <button id="fetch-profile-btn">Fetch My User Profile</button>
            <button id="logout-btn">Logout</button>
            
            <div id="api-response" style="margin-top:15px;">
                <h4>API থেকে প্রাপ্ত তথ্য:</h4>
                <pre id="profile-data"></pre>
            </div>
        </div>
    </div>


    <script>
    // নিশ্চিত করে যে পুরো HTML পেজ লোড হওয়ার পর এই কোডটি চলবে
    $(document).ready(function() {

        // --- ধাপ ১: আপনার তথ্য দিয়ে এখানে পরিবর্তন করুন ---
        const GOOGLE_CLIENT_ID = "169753588996-suef3t6v35ol4o2tp6uq6dur3o0kevnp.apps.googleusercontent.com"; // <-- আপনার Google Client ID এখানে বসানো আছে
        const FRONTEND_CALLBACK_URL = "http://localhost:3000/Front-end/login.html";  // Google Console-এ দেওয়া Redirect URI
        const BACKEND_API_URL = "http://127.0.0.1:8000/api/auth/google/login/"; // আপনার Django API-এর URL
        const USER_PROFILE_API_URL = "http://127.0.0.1:8000/api/auth/user/"; // dj-rest-auth user details endpoint

        // Helper function to show status messages
        function showStatus(message, isError = false) {
            const statusClass = isError ? 'status-error' : 'status-success';
            $('#status-container').html(`<div class="status-box ${statusClass}">${message}</div>`).show();
        }

        // --- ধাপ ২: Login বাটনে ক্লিক করলে যা হবে ---
        $('#google-login-btn').on('click', function() {
            const googleAuthUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
            
            googleAuthUrl.searchParams.append("response_type", "code");
            googleAuthUrl.searchParams.append("client_id", GOOGLE_CLIENT_ID);
            googleAuthUrl.searchParams.append("scope", "openid profile email");
            googleAuthUrl.searchParams.append("redirect_uri", FRONTEND_CALLBACK_URL);
            googleAuthUrl.searchParams.append("access_type", "offline"); // refresh token পাওয়ার জন্য

            // ব্যবহারকারীকে গুগল লগইন পেজে পাঠিয়ে দেওয়া হবে
            window.location.href = googleAuthUrl.toString();
        });
        
        // --- ধাপ ৩: পেজ লোড হওয়ার পর স্বয়ংক্রিয়ভাবে যা চেক করা হবে ---
        const urlParams = new URLSearchParams(window.location.search);
        const authCode = urlParams.get('code'); // গুগল থেকে পাওয়া কোডটি খোঁজা হচ্ছে

        if (authCode) {
            // যদি URL-এ কোড পাওয়া যায়, তাহলে ব্যাকএন্ডের সাথে যোগাযোগ করা হবে
            showStatus("Google থেকে কোড পেয়েছি। ব্যাকএন্ডের সাথে যোগাযোগ করা হচ্ছে...");
            exchangeCodeForToken(authCode);

        } else if (localStorage.getItem('access_token')) {
            // যদি কোড না থাকে, কিন্তু আগে লগইন করা টোকেন থাকে, তাহলে লগইন অবস্থা দেখানো হবে
            showLoggedInState();
        }

        // --- ধাপ ৪: কোড দিয়ে ব্যাকএন্ড থেকে টোকেন আনার ফাংশন ---
        function exchangeCodeForToken(code) {
            // URL থেকে কোডটি মুছে ফেলা হয়, যাতে পেজ রিফ্রেশ করলে আবার রিকোয়েস্ট না যায়
            window.history.pushState({}, document.title, window.location.pathname);

            $.ajax({
                url: BACKEND_API_URL,
                type: 'POST', // POST মেথড ব্যবহার করা হচ্ছে
                contentType: 'application/json',
                data: JSON.stringify({ code: code }), // কোডটি JSON ফরম্যাটে পাঠানো হচ্ছে
                success: function(response) {
                    showStatus("লগইন সফল হয়েছে! Backend থেকে JWT Token পাওয়া গেছে।");
                    
                    // টোকেনগুলো ব্রাউজারের localStorage-এ সেভ করা হচ্ছে
                    localStorage.setItem('access_token', response.access);
                    localStorage.setItem('refresh_token', response.refresh);

                    showLoggedInState(response);
                },
                error: function(xhr) {
                    console.error("Backend Error:", xhr.responseText);
                    showStatus(`ব্যাকএন্ডে সমস্যা হয়েছে: ${xhr.status} ${xhr.statusText || 'Error'}. বিস্তারিত জানতে Console দেখুন।`, true);
                }
            });
        }

        // --- ধাপ ৫: টোকেন ব্যবহার করে প্রোফাইল তথ্য আনার ফাংশন ---
        $('#fetch-profile-btn').on('click', function() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                showStatus("Access Token পাওয়া যায়নি। অনুগ্রহ করে আবার লগইন করুন।", true);
                return;
            }

            $.ajax({
                url: USER_PROFILE_API_URL,
                type: 'GET',
                beforeSend: function(xhr) {
                    // রিকোয়েস্টের সাথে Authorization হেডার যোগ করা হচ্ছে
                    xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                },
                success: function(response) {
                    $('#api-response').show();
                    $('#profile-data').text(JSON.stringify(response, null, 2));
                },
                error: function(xhr) {
                     $('#api-response').show();
                     $('#profile-data').text(`Error fetching profile: ${xhr.status}\n\n${xhr.responseText}`);
                }
            });
        });

        // --- ধাপ ৬: Logout করার ফাংশন ---
        $('#logout-btn').on('click', function() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            // পেজটি রিফ্রেশ করে লগইন অবস্থায় ফিরিয়ে আনা হবে
            window.location.href = window.location.pathname; 
        });

        // --- ধাপ ৭: লগইন করার পর UI পরিবর্তন করার ফাংশন ---
        function showLoggedInState(tokenData) {
            $('#login-section').hide();
            $('#user-info').show();

            if (tokenData) {
                 $('#jwt-tokens').text(JSON.stringify(tokenData, null, 2));
            } else {
                 $('#jwt-tokens').text("Tokens are stored in localStorage. Click 'Fetch Profile' to test.");
            }
        }
    });
    </script>
</body>
</html>