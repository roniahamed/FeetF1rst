<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Login Test</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4285F4;
            --success-color: #34a853;
            --error-color: #ea4335;
            --light-gray: #f8f9fa;
            --dark-gray: #6c757d;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #eef2f5;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            max-width: 450px;
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        h2 { font-size: 1.5rem; }
        h4 { font-size: 1rem; color: #555; margin-top: 2rem; margin-bottom: 1rem; }

        p {
            color: var(--dark-gray);
            margin-bottom: 25px;
        }

        button {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 8px;
            margin-top: 10px;
            transition: all 0.2s ease-in-out;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #google-login-btn {
            background-color: var(--primary-color);
            color: white;
        }
        #google-login-btn svg {
            width: 20px;
            height: 20px;
        }

        #logout-btn { background-color: var(--error-color); color: white; }
        #fetch-profile-btn { background-color: var(--success-color); color: white; }

        #user-info, #api-response { display: none; margin-top: 20px; }

        pre {
            background-color: var(--light-gray);
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            text-align: left;
            margin-top: 0;
        }
        
        .status-box {
            padding: 12px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
        }
        .status-success { background-color: #d1e7dd; color: #0f5132; }
        .status-error { background-color: #f8d7da; color: #842029; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Google Login Integration</h1>

        <div id="login-section">
            <p>আপনার ব্যাকএন্ড পরীক্ষা করতে নিচের বাটনে ক্লিক করুন।</p>
            <button id="google-login-btn">
                <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,34.627,44,29.69,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                <span>Sign in with Google</span>
            </button>
        </div>

        <div id="status-container"></div>
        <div class="loader" id="loader"></div>

        <div id="user-info">
            <h2>স্বাগতম!</h2>
            <h4>Backend থেকে প্রাপ্ত JWT Tokens:</h4>
            <pre id="jwt-tokens"></pre>
            <hr style="margin: 25px 0;">
            <h4>সুরক্ষিত API থেকে প্রাপ্ত আপনার তথ্য:</h4>
            <pre id="profile-data"></pre>
            <button id="fetch-profile-btn">Refresh Profile Data</button>
            <button id="logout-btn">Logout</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const GOOGLE_CLIENT_ID = "169753588996-suef3t6v35ol4o2tp6uq6dur3o0kevnp.apps.googleusercontent.com";
        const FRONTEND_CALLBACK_URL = "http://localhost:3000/Front-end/login.html";
        const BACKEND_API_URL = "http://127.0.0.1:8000/api/auth/google/login/";
        const USER_PROFILE_API_URL = "http://127.0.0.1:8000/api/auth/user/";

        const loginSection = document.getElementById('login-section');
        const userInfoSection = document.getElementById('user-info');
        const statusContainer = document.getElementById('status-container');
        const jwtTokensPre = document.getElementById('jwt-tokens');
        const profileDataPre = document.getElementById('profile-data');
        const loader = document.getElementById('loader');

        const showStatus = (message, isError = false) => {
            const statusClass = isError ? 'status-error' : 'status-success';
            statusContainer.innerHTML = `<div class="status-box ${statusClass}">${message}</div>`;
        };

        const showLoggedInState = (tokenData) => {
            loginSection.style.display = 'none';
            userInfoSection.style.display = 'block';
            jwtTokensPre.textContent = tokenData ? JSON.stringify(tokenData, null, 2) : "Tokens are stored in localStorage.";
            if (tokenData) { // Automatically fetch profile after login
                fetchUserProfile();
            }
        };

        const handleGoogleLogin = () => {
            const googleAuthUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
            googleAuthUrl.searchParams.append("response_type", "code");
            googleAuthUrl.searchParams.append("client_id", GOOGLE_CLIENT_ID);
            googleAuthUrl.searchParams.append("scope", "openid profile email");
            googleAuthUrl.searchParams.append("redirect_uri", FRONTEND_CALLBACK_URL);
            googleAuthUrl.searchParams.append("access_type", "offline");
            window.location.href = googleAuthUrl.toString();
        };

        const exchangeCodeForToken = async (code) => {
            showStatus(""); // Clear previous status
            loader.style.display = 'block';
            window.history.pushState({}, document.title, window.location.pathname);

            try {
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code }),
                });

                const data = await response.json();
                if (!response.ok) {
                    const errorMessage = (data.non_field_errors && data.non_field_errors[0]) || data.detail || `Server responded with ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                const accessToken = data.access_token || data.access;
                const refreshToken = data.refresh_token || data.refresh;

                if (!accessToken) {
                    throw new Error("Login successful, but no access token received from backend.");
                }

                localStorage.setItem('access_token', accessToken);
                localStorage.setItem('refresh_token', refreshToken);
                
                showStatus("লগইন সফল হয়েছে!");
                showLoggedInState(data);

            } catch (error) {
                console.error("Backend Error:", error);
                showStatus(`ব্যাকএন্ডে সমস্যা হয়েছে: ${error.message}`, true);
            } finally {
                loader.style.display = 'none';
            }
        };

        const fetchUserProfile = async () => {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                showStatus("Access Token পাওয়া যায়নি। অনুগ্রহ করে আবার লগইন করুন।", true);
                return;
            }
            loader.style.display = 'block';
            profileDataPre.textContent = "Fetching data...";

            try {
                const response = await fetch(USER_PROFILE_API_URL, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                });
                
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || JSON.stringify(data));
                }
                
                profileDataPre.textContent = JSON.stringify(data, null, 2);

            } catch (error) {
                profileDataPre.textContent = `Error fetching profile: ${error.message}`;
            } finally {
                 loader.style.display = 'none';
            }
        };

        const handleLogout = () => {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = window.location.pathname;
        };

        document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
        document.getElementById('fetch-profile-btn').addEventListener('click', fetchUserProfile);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        const urlParams = new URLSearchParams(window.location.search);
        const authCode = urlParams.get('code');
        
        if (authCode) {
            exchangeCodeForToken(authCode);
        } else if (localStorage.getItem('access_token')) {
            showLoggedInState();
            fetchUserProfile(); // Fetch profile if already logged in
        }
    });
    </script>
</body>
</html>